name: Deploy via SCP

# ¿Cuándo se ejecuta? Al hacer push a la rama 'main' o 'master'
on:
  push:
    branches: [ "main", "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    # 1. Descargar tu código del repositorio
    - uses: actions/checkout@v3

    # 2. Copiar los archivos al VPS usando SCP
    - name: Copy files to VPS
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST_IP }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: 22  # ¡TU PUERTO SSH PERSONALIZADO!
        source: "docker-compose.yml,xray/*,nginx/*,cerbot/*"
        target: "~/vps-b-backend" # Carpeta destino en el VPS

    # 3. Conectarse por SSH y reiniciar Docker
    - name: Restart Docker
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST_IP }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        script: |
          # Entrar a la carpeta
          cd ~/vps-b-backend
          
          # Apagar contenedores viejos (si existen)
          docker compose down || true
          
          # Levantar nuevos contenedores reconstruyendo la imagen
          docker compose up -d --build
